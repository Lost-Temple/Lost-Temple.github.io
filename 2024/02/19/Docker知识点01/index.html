<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Docker知识点01 | 一个码农的自白</title><meta name="keywords" content="swarm,docker,mtu,bridge,overlay,network"><meta name="author" content="暂留白"><meta name="copyright" content="暂留白"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="名词   名词 说明    Bridge 网络 1. Bridge 网络是 Docker 默认创建的网络模式。当您在 Docker 中创建一个新的容器时，默认会将容器连接到名为 bridge 的网络中  2. Bridge 网络允许容器与宿主机以及同一主机上的其他容器进行通信，但默认情况下不允许容器之间跨主机通信  3. Bridge 网络使用 Linux 系统上的桥接技术，在宿主机上创建一个虚拟">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker知识点01">
<meta property="og:url" content="http://www.blockchainof.com/2024/02/19/Docker%E7%9F%A5%E8%AF%86%E7%82%B901/index.html">
<meta property="og:site_name" content="一个码农的自白">
<meta property="og:description" content="名词   名词 说明    Bridge 网络 1. Bridge 网络是 Docker 默认创建的网络模式。当您在 Docker 中创建一个新的容器时，默认会将容器连接到名为 bridge 的网络中  2. Bridge 网络允许容器与宿主机以及同一主机上的其他容器进行通信，但默认情况下不允许容器之间跨主机通信  3. Bridge 网络使用 Linux 系统上的桥接技术，在宿主机上创建一个虚拟">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/02/20/fnPqBZJia8KLhEW.png">
<meta property="article:published_time" content="2024-02-19T01:16:00.000Z">
<meta property="article:modified_time" content="2024-02-20T02:30:41.164Z">
<meta property="article:author" content="暂留白">
<meta property="article:tag" content="swarm">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="mtu">
<meta property="article:tag" content="bridge">
<meta property="article:tag" content="overlay">
<meta property="article:tag" content="network">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/02/20/fnPqBZJia8KLhEW.png"><link rel="shortcut icon" href="/img/favicon.svg"><link rel="canonical" href="http://www.blockchainof.com/2024/02/19/Docker%E7%9F%A5%E8%AF%86%E7%82%B901/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Docker知识点01',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-02-20 10:30:41'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.svg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/02/20/fnPqBZJia8KLhEW.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">一个码农的自白</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Docker知识点01</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-02-19T01:16:00.000Z" title="发表于 2024-02-19 09:16:00">2024-02-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-20T02:30:41.164Z" title="更新于 2024-02-20 10:30:41">2024-02-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Docker知识点01"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h1><table>
<thead>
<tr>
<th align="left">名词</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Bridge 网络</td>
<td align="left">1. Bridge 网络是 Docker 默认创建的网络模式。当您在 Docker 中创建一个新的容器时，默认会将容器连接到名为 bridge 的网络中 <br> 2. Bridge 网络允许容器与宿主机以及同一主机上的其他容器进行通信，但默认情况下不允许容器之间跨主机通信 <br> 3. Bridge 网络使用 Linux 系统上的桥接技术，在宿主机上创建一个虚拟的网桥设备，用于连接容器和主机的物理网络接口 <br> 4. Bridge 网络适用于单个主机上的容器通信</td>
</tr>
<tr>
<td align="left">Overlay 网络</td>
<td align="left">1. Overlay 网络用于跨多个 Docker 主机构建容器集群，并允许集群中的容器之间进行跨主机通信 <br> 2. Overlay 网络使用了 VxLAN 技术，在不同主机上创建虚拟的 Overlay 网络，容器可以通过该网络进行通信 <br> 3. Overlay 网络通常用于 Docker Swarm 集群或 Kubernetes 集群中，用于构建分布式应用和微服务架构 <br> 4. Overlay 网络适用于跨多个主机的容器通信</td>
</tr>
<tr>
<td align="left">MTU</td>
<td align="left">最大传输单元MTU（Maximum Transmission Unit，MTU），是指网络能够传输的最大数据包大小，以字节为单位。MTU的大小决定了发送端一次能够发送报文的最大字节数。如果MTU超过了接收端所能够承受的最大值，或者是超过了发送路径上途经的某台设备所能够承受的最大值，就会造成报文分片甚至丢弃，加重网络传输的负担。如果太小，那实际传送的数据量就会过小，影响传输效率。</td>
</tr>
</tbody></table>
<h1 id="Overlay网络"><a href="#Overlay网络" class="headerlink" title="Overlay网络"></a>Overlay网络</h1><p>docker swarm在启动的过程中会创建两个默认的网络：docker_gwbridge和ingress.</p>
<ul>
<li><strong>docker_gwbridge</strong>：通过这个网络，容器可以连接到宿主机。（它的driver就是bridge)</li>
<li><strong>ingress</strong>：由docker swarm创建的overlay网络，这个网络用于将服务暴露给外部访问，docker swarm就是通过它实现的routing mesh（将外部请求路由到不同主机的容器）。</li>
</ul>
<p>例子如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[centos@bd-2 ~]$ docker network ls</span><br><span class="line">NETWORK ID     NAME                           DRIVER    SCOPE</span><br><span class="line">69477a3560e9   bridge                         bridge    local</span><br><span class="line">320cd9ae8475   centos_default                 bridge    local</span><br><span class="line">d344065cc4cc   docker_gwbridge                bridge    local</span><br><span class="line">da5d24e5d251   flow-admin-backend_admin-net   bridge    local</span><br><span class="line">4d5b92424942   flow-admin-front_admin-net     bridge    local</span><br><span class="line">qqfrntz0lrex   hadoop-com                     overlay   swarm</span><br><span class="line">5cd8e1bc97a5   host                           host      local</span><br><span class="line">mtysig457puz   ingress                        overlay   swarm</span><br><span class="line">7ad98d08bd3c   none                           null      local  </span><br></pre></td></tr></table></figure>

<h1 id="docker0的mtu"><a href="#docker0的mtu" class="headerlink" title="docker0的mtu"></a>docker0的mtu</h1><p>mtu查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig | grep mtu</span><br></pre></td></tr></table></figure>
<p>如果宿主机的mtu比docker0的mtu还小，网络会存在问题，所以是需要修改docker0的mtu</p>
<p>我直接通过修改&#x2F;etc&#x2F;docker&#x2F;daemon.json文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span><span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span><span class="string">&quot;200m&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span><span class="string">&quot;3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;live-restore&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mtu&quot;</span><span class="punctuation">:</span> <span class="number">1450</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;192.168.10.166:88&quot;</span><span class="punctuation">,</span><span class="string">&quot;192.168.9.68&quot;</span><span class="punctuation">,</span><span class="string">&quot;192.168.11.149:8888&quot;</span><span class="punctuation">,</span><span class="string">&quot;192.168.11.168:8888&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>重启docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>重新查看mtu，如果docker中此时没有容器在运行，那会发现docker0的mtu还是原先的值。这里有坑：当docker中有容器在运行时，再去查看docker0的mtu就生效了。<br>强迫症可以修改daemon.json配置，重启docker服务后，再使用命令临时修改docker0的mtu：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link set docker0 mtu 1450</span><br></pre></td></tr></table></figure>

<h1 id="Swarm集群搭建"><a href="#Swarm集群搭建" class="headerlink" title="Swarm集群搭建"></a>Swarm集群搭建</h1><p>初始化manager节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 192.168.10.91:2377</span><br></pre></td></tr></table></figure>
<p>正常情况输出类似以下的提示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Swarm initialized: current node (tg66scjfm2kgw5z7pb7vpnrye) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4e22sso1h4dofwqzq25a6crgc9fzk4it6237jdd6ezuzqknsw5-79qgv3b9sc88wa8jk5etylpty 192.168.10.91:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span><br></pre></td></tr></table></figure>

<p>后续想要查看怎么加入到swarm集群，使用以下命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取Manager节点加入命令</span></span><br><span class="line">docker swarm join-token manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取Worker节点加入命令</span></span><br><span class="line">docker swarm join-token worker</span><br></pre></td></tr></table></figure>

<p>可以到work节点上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-4e22sso1h4dofwqzq25a6crgc9fzk4it6237jdd6ezuzqknsw5-79qgv3b9sc88wa8jk5etylpty 192.168.10.91:2377</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果是多manager的话，可以在其它manager节点执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-4e22sso1h4dofwqzq25a6crgc9fzk4it6237jdd6ezuzqknsw5-2ccx8qd17rc0ydci0kcw9qfy2 192.168.10.91:2377</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里有坑，就是docker的daemon.json中配置的mtu，对于swarm的overlay网络是不起作用的。</p>
</blockquote>
<p>修改overlay网络的mtu和eth0,docker0的mtu保持一致</p>
<ol>
<li><p>在manager节点中先获取子网信息</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect -f &#x27;&#123;&#123;json .IPAM&#125;&#125;&#x27; docker_gwbridge</span><br></pre></td></tr></table></figure>
<p>返回：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Driver&quot;:&quot;default&quot;,&quot;Options&quot;:null,&quot;Config&quot;:[&#123;&quot;Subnet&quot;:&quot;172.18.0.0/16&quot;,&quot;Gateway&quot;:&quot;172.18.0.1&quot;&#125;]&#125; </span><br></pre></td></tr></table></figure></li>
<li><p>manager节点退出swarm集群(自定义docker_gwbridge网络，则必须在将 Docker 主机加入 swarm 之前或暂时从 swarm 中移除后进行)</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm leave --force</span><br></pre></td></tr></table></figure></li>
<li><p>manager节点停掉docker服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop docker.service</span><br></pre></td></tr></table></figure></li>
<li><p>manager节点中删掉虚拟网卡docker_gwbridge</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link set docker_gwbridge down</span><br><span class="line">sudo ip link del dev docker_gwbridge</span><br></pre></td></tr></table></figure></li>
<li><p>manager节点中启动docker</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker.service</span><br></pre></td></tr></table></figure></li>
<li><p>manager节点中重建docker_gwbridge（这一步用到了第1步获取的子网信息以及设置我们要的mtu值）</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker network rm docker_gwbridge</span><br><span class="line">docker network create \</span><br><span class="line">  --subnet 172.18.0.0/16 \</span><br><span class="line">  --gateway 172.18.0.1 \</span><br><span class="line">  --opt com.docker.network.bridge.name=docker_gwbridge \</span><br><span class="line">  --opt com.docker.network.bridge.enable_icc=false \</span><br><span class="line">  --opt com.docker.network.bridge.enable_ip_masquerade=true \</span><br><span class="line">  --opt com.docker.network.driver.mtu=1450 \</span><br><span class="line">  docker_gwbridge</span><br></pre></td></tr></table></figure>
<p><strong>再到work节点上执行相同的命令执行1~6步骤</strong>完成docker_gwbridge网络的自定义创建</p>
</li>
<li><p>manager节点中查看ingress网络信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect -f &#x27;&#123;&#123;json .IPAM&#125;&#125;&#x27; ingress</span><br></pre></td></tr></table></figure>
<p>返回</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Driver&quot;:&quot;default&quot;,&quot;Options&quot;:null,&quot;Config&quot;:[&#123;&quot;Subnet&quot;:&quot;10.0.0.0/24&quot;,&quot;Gateway&quot;:&quot;10.0.0.1&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>manager节点中删除ingress network</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network rm ingress</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这一步会有个警告</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING! Before removing the routing-mesh network, make sure all the nodes in your swarm run the same docker engine version. Otherwise, removal may not be effective and functionality of newly create ingress networks will be impaired.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>所以swarm中的节点的docker版本最好保持一致</p>
</blockquote>
</li>
<li><p>manager节点中重建ingress(记得使用之前查看的ingress网络中的子网以及网关，mtu自定义修改)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network create \</span><br><span class="line">  --driver overlay \</span><br><span class="line">  --ingress \</span><br><span class="line">  --subnet=10.0.0.0/24 \</span><br><span class="line">  --gateway=10.0.0.1 \</span><br><span class="line">  --opt com.docker.network.driver.mtu=1450 \</span><br><span class="line">  ingress</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后就是其它的manager节点&#x2F;worker节点的加入了</p>
</li>
</ol>
<blockquote>
<p><strong>注意：新机器在join到swarm之前，得先重建docker_gwbridge(mtu得保持一致）</strong></p>
</blockquote>
<ol start="11">
<li>验证mtu是否都按我们定义的修改了<br>   启动一个swarm service   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create -td --name busybox busybox</span><br></pre></td></tr></table></figure>
   查看mtu   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig | grep mtu</span><br></pre></td></tr></table></figure>
   返回   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">docker_gwbridge: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">veth21384b6: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">veth41d39c5: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br></pre></td></tr></table></figure></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.blockchainof.com">暂留白</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.blockchainof.com/2024/02/19/Docker%E7%9F%A5%E8%AF%86%E7%82%B901/">http://www.blockchainof.com/2024/02/19/Docker%E7%9F%A5%E8%AF%86%E7%82%B901/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.blockchainof.com" target="_blank">一个码农的自白</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/swarm/">swarm</a><a class="post-meta__tags" href="/tags/docker/">docker</a><a class="post-meta__tags" href="/tags/mtu/">mtu</a><a class="post-meta__tags" href="/tags/bridge/">bridge</a><a class="post-meta__tags" href="/tags/overlay/">overlay</a><a class="post-meta__tags" href="/tags/network/">network</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2024/02/20/fnPqBZJia8KLhEW.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/02/18/nfs%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95/"><img class="next-cover" src="https://s2.loli.net/2024/02/18/SofQ9nNGWbZesBy.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">nfs共享目录</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.svg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">暂留白</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">74</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">35</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lost-Temple"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">码农的自留地</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D"><span class="toc-number">1.</span> <span class="toc-text">名词</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Overlay%E7%BD%91%E7%BB%9C"><span class="toc-number">2.</span> <span class="toc-text">Overlay网络</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker0%E7%9A%84mtu"><span class="toc-number">3.</span> <span class="toc-text">docker0的mtu</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Swarm%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">4.</span> <span class="toc-text">Swarm集群搭建</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/02/19/Docker%E7%9F%A5%E8%AF%86%E7%82%B901/" title="Docker知识点01"><img src="https://s2.loli.net/2024/02/20/fnPqBZJia8KLhEW.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker知识点01"/></a><div class="content"><a class="title" href="/2024/02/19/Docker%E7%9F%A5%E8%AF%86%E7%82%B901/" title="Docker知识点01">Docker知识点01</a><time datetime="2024-02-19T01:16:00.000Z" title="发表于 2024-02-19 09:16:00">2024-02-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/02/18/nfs%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95/" title="nfs共享目录"><img src="https://s2.loli.net/2024/02/18/SofQ9nNGWbZesBy.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="nfs共享目录"/></a><div class="content"><a class="title" href="/2024/02/18/nfs%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95/" title="nfs共享目录">nfs共享目录</a><time datetime="2024-02-18T07:17:59.000Z" title="发表于 2024-02-18 15:17:59">2024-02-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/14/Flink-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0-Window-%E6%9C%BA%E5%88%B6/" title="Flink原理与实现:Window机制"><img src="https://s2.loli.net/2023/12/06/jHIybYlRgtNS8O7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink原理与实现:Window机制"/></a><div class="content"><a class="title" href="/2023/12/14/Flink-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0-Window-%E6%9C%BA%E5%88%B6/" title="Flink原理与实现:Window机制">Flink原理与实现:Window机制</a><time datetime="2023-12-14T02:58:46.000Z" title="发表于 2023-12-14 10:58:46">2023-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/06/Storm%E3%80%81Spark%E4%B8%8EFlink%E5%AF%B9%E6%AF%94/" title="Storm、Spark与Flink对比"><img src="https://s2.loli.net/2023/12/06/rZykfszoeKCjVhL.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Storm、Spark与Flink对比"/></a><div class="content"><a class="title" href="/2023/12/06/Storm%E3%80%81Spark%E4%B8%8EFlink%E5%AF%B9%E6%AF%94/" title="Storm、Spark与Flink对比">Storm、Spark与Flink对比</a><time datetime="2023-12-06T08:06:42.000Z" title="发表于 2023-12-06 16:06:42">2023-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/31/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80-%E6%A6%82%E7%8E%87%E5%92%8C%E5%8F%91%E7%94%9F%E6%AF%94%E4%BB%A5%E5%8F%8ALogit/" title="机器学习基础-概率和发生比以及Logit"><img src="https://s2.loli.net/2023/10/31/rl56CdDAOqneHZQ.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="机器学习基础-概率和发生比以及Logit"/></a><div class="content"><a class="title" href="/2023/10/31/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80-%E6%A6%82%E7%8E%87%E5%92%8C%E5%8F%91%E7%94%9F%E6%AF%94%E4%BB%A5%E5%8F%8ALogit/" title="机器学习基础-概率和发生比以及Logit">机器学习基础-概率和发生比以及Logit</a><time datetime="2023-10-31T10:57:17.000Z" title="发表于 2023-10-31 18:57:17">2023-10-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By 暂留白</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>